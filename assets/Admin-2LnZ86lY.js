import{d as C,r,u as E,c as i,j as e,t as B,B as u}from"./index-B4XHSPnD.js";import{F as N,M as z,S as I,U as L,R as V,D as K,p as Q}from"./date-CCZRwvqA.js";import{s as H}from"./crypto-Cw3CO9Ve.js";import{s as t}from"./index-CmOMhBeX.js";import{C as J,T as G}from"./index-Df6S2W6E.js";import{S as w}from"./TextArea-BUjP_gK1.js";import{I as U,F as j,a as F}from"./index-DCSwNLov.js";import{R as W}from"./ArrowLeftOutlined-biIKJtLJ.js";import{T as X}from"./index-ke0NPmg-.js";import{K as Y}from"./key-round-BdiZPpVi.js";import"./index-CHtsP9lT.js";const Z=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],ee=C("check",Z);const se=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],ae=C("circle-alert",se);const te=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m4.243 5.21 14.39 12.472",key:"1c9a7c"}]],D=C("shield-ban",te);const re=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],A=C("square-pen",re);const ne=[["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],R=C("trash",ne),{TextArea:oe}=U;function le({systemRole:x}){const[b,y]=r.useState(!1),[g,h]=r.useState([]),[c,S]=r.useState(""),[n,l]=r.useState(!1),[v,f]=r.useState(!1),[m,a]=r.useState(null),[o]=j.useForm(),[p]=j.useForm();r.useEffect(()=>{k()},[]);const k=async()=>{y(!0);try{const s=c?`/admin/users/search?q=${c}`:"/admin/users",{data:d}=await i.get(s);h(d.data||[])}catch{t.error("Failed to fetch users")}finally{y(!1)}},T=async s=>{z.confirm({title:"Are you sure?",content:"This action cannot be undone.",onOk:async()=>{try{await i.post(`/admin/user/delete?username=${s}`),t.success("User deleted"),k()}catch{t.error("Delete failed")}}})},M=s=>{a(s),o.setFieldsValue({email:s.email,nickname:s.nickname,avatarUrl:s.avatarUrl,role:s.role}),l(!0)},P=async()=>{try{const s=await o.validateFields();await i.post("/admin/user/update",{username:m?.username,email:s.email,nickname:s.nickname,avatarUrl:s.avatarUrl}),x==="root"&&s.role!==m?.role&&await i.post("/root/user/role",{username:m?.username,role:s.role}),t.success("User updated"),l(!1),k()}catch{t.error("Update failed")}},_=s=>{a(s),p.resetFields(),f(!0)},q=async()=>{try{const s=await p.validateFields();await i.post("/admin/user/reset-password",{username:m?.username,password:await H(s.password)}),t.success("Password reset"),f(!1)}catch{t.error("Reset failed")}},O=async s=>{try{await i.post("/admin/user/verify",{username:s.username}),t.success("User verified"),k()}catch{t.error("Verification failed")}},$=[{title:"Username",dataIndex:"username",key:"username",render:(s,d)=>e.jsxs(w,{children:[d.username,!d.isVerified&&e.jsx("span",{title:"Unverified",children:e.jsx(ae,{size:16,color:"orange"})})]})},{title:"Email",dataIndex:"email",key:"email"},{title:"Role",dataIndex:"role",key:"role",render:s=>e.jsx(X,{color:s==="root"?"red":s==="admin"?"blue":"green",children:s.toUpperCase()})},{title:"Actions",key:"actions",render:(s,d)=>e.jsxs(w,{children:[e.jsx(u,{icon:e.jsx(A,{size:14}),size:"small",onClick:()=>M(d),title:"Edit Profile"}),e.jsx(u,{icon:e.jsx(Y,{size:14}),size:"small",onClick:()=>_(d),title:"Reset Password"}),e.jsx(u,{danger:!0,icon:e.jsx(R,{size:14}),size:"small",onClick:()=>T(d.username),title:"Delete User"}),!d.isVerified&&e.jsx(u,{icon:e.jsx(ee,{size:14}),size:"small",onClick:()=>O(d),title:"Verify User",type:"primary",ghost:!0})]})}];return e.jsxs(e.Fragment,{children:[e.jsxs(w.Compact,{className:"w-full mb-5",children:[e.jsx(U,{placeholder:"Search users...",prefix:e.jsx(F,{}),value:c,onChange:s=>S(s.target.value),onPressEnter:k,className:"max-w-md"}),e.jsx(u,{type:"primary",onClick:k,children:"Search"})]}),e.jsx(N,{columns:$,dataSource:g,rowKey:"username",loading:b,pagination:{pageSize:10}}),e.jsx(z,{title:"Edit User",open:n,onOk:P,onCancel:()=>l(!1),children:e.jsxs(j,{form:o,layout:"vertical",children:[e.jsx(j.Item,{name:"email",label:"Email",rules:[{required:!0}],children:e.jsx(U,{})}),e.jsx(j.Item,{name:"nickname",label:"Nickname",children:e.jsx(U,{})}),e.jsx(j.Item,{name:"avatarUrl",label:"Avatar URL",children:e.jsx(U,{})}),x==="root"&&e.jsx(j.Item,{name:"role",label:e.jsxs(e.Fragment,{children:[e.jsx(D,{size:16})," Role"]}),children:e.jsxs(I,{children:[e.jsx(I.Option,{value:"user",children:"User"}),e.jsx(I.Option,{value:"admin",children:"Admin"}),e.jsx(I.Option,{value:"root",children:"Root"})]})})]})}),e.jsx(z,{title:"Reset Password",open:v,onOk:q,onCancel:()=>f(!1),children:e.jsx(j,{form:p,layout:"vertical",children:e.jsx(j.Item,{name:"password",label:"New Password",rules:[{required:!0,min:6}],children:e.jsx(U.Password,{})})})})]})}function ie({systemRole:x}){const[b,y]=r.useState(!1),[g,h]=r.useState([]),[c,S]=r.useState(""),n=E();r.useEffect(()=>{l()},[]);const l=async()=>{y(!0);try{const a=c?`/admin/apps?q=${c}`:"/admin/apps",{data:o}=await i.get(a);h(o.data||[])}catch{t.error("Failed to fetch apps")}finally{y(!1)}},v=async(a,o)=>{try{await i.post("/admin/app/suspend",{appId:a,suspendUntil:o?o.toISOString():null}),t.success("Suspension updated"),l()}catch{t.error("Failed to update suspension")}},f=async a=>{z.confirm({title:"Delete App?",content:"This will delete the app and all associated data permanently. Cannot be undone.",okType:"danger",onOk:async()=>{try{await i.post(`/admin/app/delete?id=${a}`),t.success("App deleted"),l()}catch{t.error("Delete failed")}}})},m=[{title:"Name",dataIndex:"name",key:"name",render:(a,o)=>e.jsxs(w,{children:[o.logoUrl&&e.jsx("img",{src:o.logoUrl,alt:"icon",className:"w-6 h-6 rounded"}),a]})},{title:"ID",dataIndex:"id",key:"id",ellipsis:!0},{title:"Description",dataIndex:"description",key:"description",ellipsis:!0},{title:"Suspension",dataIndex:"suspendUntil",key:"suspendUntil",render:(a,o)=>e.jsx(K,{showTime:!0,value:a?Q(a):null,onChange:p=>v(o.id,p),allowClear:!0})},{title:"Actions",key:"actions",render:(a,o)=>e.jsxs(w,{children:[e.jsx(u,{icon:e.jsx(A,{size:14}),size:"small",onClick:()=>n(`/manage/${o.id}`),title:"Edit App"}),e.jsx(u,{danger:!0,icon:e.jsx(R,{size:14}),size:"small",onClick:()=>f(o.id),title:"Delete App"})]})}];return e.jsxs(e.Fragment,{children:[e.jsxs(w.Compact,{className:"w-full mb-5",children:[e.jsx(U,{placeholder:"Search apps...",prefix:e.jsx(F,{}),value:c,onChange:a=>S(a.target.value),onPressEnter:l,className:"max-w-md"}),e.jsx(u,{type:"primary",onClick:l,children:"Search"})]}),e.jsx(N,{columns:m,dataSource:g,rowKey:"id",loading:b,pagination:{pageSize:10}})]})}function ce(){const[x,b]=r.useState([]),[y,g]=r.useState(!1);r.useEffect(()=>{h()},[]);const h=async()=>{g(!0);try{const{data:n}=await i.get("/admin/blobs");b(n.data||[])}catch{t.error("Failed to load blobs")}finally{g(!1)}},c=async n=>{try{await i.post("/admin/blob/delete",{id:n}),t.success("Deleted"),h()}catch{t.error("Delete failed")}},S=async n=>{const{file:l,onSuccess:v,onError:f}=n,m=new FormData;m.append("file",l);try{await i.post("/admin/blob/upload",m,{headers:{"Content-Type":"multipart/form-data"}}),t.success("Uploaded"),v("ok"),h()}catch(a){f(a),t.error("Upload failed")}};return e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsx(L,{customRequest:S,showUploadList:!1,children:e.jsx(u,{icon:e.jsx(V,{}),children:"Upload Blob"})})}),e.jsx(N,{dataSource:x,rowKey:"ID",loading:y,columns:[{title:"ID",dataIndex:"ID",render:n=>e.jsx("a",{href:`${i.defaults.baseURL||""}/blob/${n}`,target:"_blank",rel:"noreferrer",children:n})},{title:"Size",dataIndex:"Size",render:n=>(n/1024).toFixed(1)+" KB"},{title:"Type",dataIndex:"ContentType"},{title:"Action",render:(n,l)=>e.jsx(u,{danger:!0,size:"small",onClick:()=>c(l.ID),icon:e.jsx(R,{size:14})})}]})]})}function we(){const[x,b]=r.useState(""),[y,g]=r.useState(!0),h=E(),[c,S]=r.useState(""),[n,l]=r.useState(null);r.useEffect(()=>{v()},[]);const v=async()=>{try{const{data:a}=await i.get("/myapps"),p=(a.data||[]).find(k=>k.name==="system");if(!p||p.role!=="admin"&&p.role!=="root"){t.error("Unauthorized access"),h("/dashboard");return}b(p.role)}catch{t.error("Failed to authenticate")}finally{g(!1)}};if(y)return e.jsx(B,{});const f=async()=>{try{const{data:a}=await i.post("/root/sql",{query:c});l(a.data),t.success("Query executed")}catch(a){t.error(a.response?.data?.message||"Query failed"),l(null)}},m=[{key:"1",label:"Users",children:e.jsx(le,{systemRole:x})},{key:"2",label:"Applications",children:e.jsx(ie,{systemRole:x})},{key:"3",label:"Blobs",children:e.jsx(ce,{})}];return e.jsx(J,{title:"System Management",className:"shadow-xl w-full max-w-4xl",extra:e.jsx(u,{icon:e.jsx(W,{}),onClick:()=>h(-1),children:"Back"}),children:e.jsxs(w,{direction:"vertical",className:"w-full",children:[e.jsx(G,{defaultActiveKey:"1",items:m}),x==="root"&&e.jsx("div",{className:"bg-gray-50 dark:bg-gray-900 p-6 rounded-xl border border-gray-200 dark:border-gray-700 mt-8",children:e.jsxs(w,{direction:"vertical",className:"w-full",children:[e.jsx(oe,{rows:4,value:c,onChange:a=>S(a.target.value),placeholder:"SELECT * FROM users;",className:"font-mono border-none"}),e.jsxs(u,{type:"primary",onClick:f,children:[e.jsx(D,{size:18}),"Execute SQL"]}),n&&e.jsx("div",{className:"overflow-x-auto p-2 rounded-lg mt-2 border border-gray-200",children:e.jsx("pre",{className:"text-xs font-mono",children:JSON.stringify(n,null,2)})})]})})]})})}export{we as default};
