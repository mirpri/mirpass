import{r as n,u as Y,a as B,b as O,j as e,R as W,B as u,A as I,L as P,c as G}from"./index-BtQilkke.js";import{s as H}from"./crypto-Cw3CO9Ve.js";import{s as a}from"./index-xphwZMwG.js";import{C as y}from"./index-BTQ6B5bA.js";import{T as J}from"./index-CNaZsIK2.js";import{S as f}from"./TextArea-d1BLIjnm.js";import{D as K}from"./index-Ddxff6ue.js";import{R as F,a as Q}from"./UserOutlined-bQhU1XY7.js";import{F as p,I as L}from"./index-Du-RPus6.js";const{Title:w,Text:o}=J;function te({onLogin:z,isAuthenticated:x}){const[E,N]=n.useState(!1),h=Y(),[l,v]=B(),{ssoSessionId:R,fromPath:T,setSsoSessionId:t,setFromPath:S,ssoDetails:s,ssoConfirm:U,fetchSsoDetails:$,profile:g,logout:A}=O(),c=l.get("sso"),d=l.get("from");n.useEffect(()=>{c&&t(c),d&&S(d)},[c,d,t,S]);const r=c||R,b=d||T,[D,k]=n.useState(!1);n.useEffect(()=>{x&&!r&&h("/dashboard",{replace:!0})},[x,h,r]),n.useEffect(()=>{r&&(t(r),$().then(()=>{s?.status==="confirmed"&&(a.success(`Already logged in to ${s.appName}`),t(null))}).catch(()=>{a.error("Failed to fetch SSO details"),t(null),h("/login",{replace:!0})}))},[r]),n.useEffect(()=>{if(l.get("verified")==="true"){a.success("Email verified. You can log in now.");const i=new URLSearchParams(l);i.delete("verified"),v(i,{replace:!0})}},[l,v]);const q=async i=>{N(!0);try{const j={...i,password:await H(i.password)},{data:m}=await G.post("/login",j),C=m?.data?.token;if(!C)throw new Error("Missing token from server response");a.success(m?.message||"Logged in"),z(C)}catch(j){const m=j;a.error(m.response?.data?.message||"Failed to login")}finally{N(!1)}},M=async()=>{if(r){k(!0);try{await U(),t(null),a.success(`Logged in to ${s?.appName}`),b&&setTimeout(()=>{window.location.href=b},500)}catch{a.error("Failed to confirm login")}finally{k(!1)}}};return r&&s?.status==="confirmed"?e.jsx(y,{className:"max-w-sm w-full shadow-2xl",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(W,{className:"text-6xl text-green-500 mb-4"}),e.jsx(w,{level:3,children:"Success!"}),e.jsxs(o,{className:"block mb-6",children:["You have logged in to ",s.appName,".",e.jsx("br",{}),"You can close this window now."]}),e.jsx(u,{type:"default",onClick:()=>window.close(),children:"Close Window"})]})}):r&&x&&s?e.jsx(y,{className:"max-w-sm w-full shadow-2xl",children:e.jsxs(f,{direction:"vertical",size:"large",className:"w-full text-center",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(I,{size:64,src:s.logoUrl,style:{margin:"10px"},children:s.appName.charAt(0).toUpperCase()}),e.jsx(w,{level:3,className:"m-0",children:s.appName}),e.jsx(o,{type:"secondary",children:"wants to access your account"})]}),e.jsx(K,{className:"my-2"}),e.jsxs("div",{className:"text-left bg-gray-50 dark:bg-gray-800 border border-gray-100 dark:border-gray-700 p-4 rounded-lg",children:[e.jsx(o,{type:"secondary",className:"text-xs uppercase font-bold tracking-wider",children:"Signed in as"}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx(I,{src:g?.avatarUrl,icon:e.jsx(F,{})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(o,{strong:!0,children:g?.nickname}),e.jsx(o,{type:"secondary",children:g?.username})]})]})]}),e.jsxs(u,{type:"primary",size:"large",block:!0,onClick:M,loading:D,children:["Continue to ",s.appName]}),e.jsx(u,{type:"text",block:!0,onClick:A,children:"Change Account"})]})}):e.jsx(y,{className:"max-w-sm w-full shadow-2xl",children:e.jsxs(f,{direction:"vertical",size:"large",className:"w-full",children:[e.jsxs(f,{direction:"vertical",size:4,children:[e.jsx(w,{level:3,className:"m-0",children:r&&s?`Login to ${s.appName}`:"Login"}),e.jsx(o,{type:"secondary",children:r?"Sign in to continue":"Login to continue to your dashboard"})]}),e.jsxs(p,{layout:"vertical",onFinish:q,requiredMark:!1,children:[e.jsx(p.Item,{label:"Username",name:"username",rules:[{required:!0,message:"Please enter your username"}],children:e.jsx(L,{size:"large",prefix:e.jsx(F,{}),placeholder:"johndoe"})}),e.jsx(p.Item,{label:"Password",name:"password",rules:[{required:!0,message:"Please enter your password"}],children:e.jsx(L.Password,{size:"large",prefix:e.jsx(Q,{}),placeholder:"••••••••",autoComplete:"current-password"})}),e.jsx(p.Item,{children:e.jsx(u,{type:"primary",htmlType:"submit",size:"large",block:!0,loading:E,children:"Sign in"})})]}),e.jsxs(f,{direction:"vertical",size:4,children:[e.jsxs(o,{type:"secondary",children:["New here? ",e.jsx(P,{to:"/register",children:"Create an account"})]}),e.jsx(P,{to:"/forget",children:"Forgot Password?"})]})]})})}export{te as default};
