import{e as I,A as z,r as n,a as N,d as i,j as e,f as V,S as w,B as p,g as K}from"./index-q3coxKpc.js";import{F as R,M as F,S as A,U as Q,R as H,D as J,p as G}from"./date-k-oYsZNN.js";import{s as W}from"./crypto-B9Mf35RN.js";import{C as X,T as Y}from"./index-C6EakQ48.js";import{I as U,F as j,a as D}from"./index-BGxdU0Dl.js";import{R as Z}from"./ArrowLeftOutlined-DBF4nafy.js";import{T as ee}from"./index-Diw1ml-f.js";import{K as se}from"./key-round-DPiYr9db.js";import"./TextArea-DBS6MHTP.js";import"./index-C_ZdSUz6.js";const ae=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],te=I("check",ae);const re=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],ne=I("circle-alert",re);const oe=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m4.243 5.21 14.39 12.472",key:"1c9a7c"}]],T=I("shield-ban",oe);const le=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],P=I("square-pen",le);const ie=[["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],E=I("trash",ie),{TextArea:ce}=U;function de({systemRole:c}){const{message:t,modal:b}=z.useApp(),[S,h]=n.useState(!1),[x,g]=n.useState([]),[m,o]=n.useState(""),[y,d]=n.useState(!1),[v,f]=n.useState(!1),[l,a]=n.useState(null),[r]=j.useForm(),[k]=j.useForm();n.useEffect(()=>{C()},[]);const C=async()=>{h(!0);try{const s=m?`/admin/users/search?q=${m}`:"/admin/users",{data:u}=await i.get(s);g(u.data||[])}catch{t.error("Failed to fetch users")}finally{h(!1)}},_=async s=>{b.confirm({title:"Are you sure?",content:"This action cannot be undone.",onOk:async()=>{try{await i.post(`/admin/user/delete?username=${s}`),t.success("User deleted"),C()}catch{t.error("Delete failed")}}})},M=s=>{a(s),r.setFieldsValue({email:s.email,nickname:s.nickname,avatarUrl:s.avatarUrl,role:s.role}),d(!0)},q=async()=>{try{const s=await r.validateFields();await i.post("/admin/user/update",{username:l?.username,email:s.email,nickname:s.nickname,avatarUrl:s.avatarUrl}),c==="root"&&s.role!==l?.role&&await i.post("/root/user/role",{username:l?.username,role:s.role}),t.success("User updated"),d(!1),C()}catch{t.error("Update failed")}},O=s=>{a(s),k.resetFields(),f(!0)},$=async()=>{try{const s=await k.validateFields();await i.post("/admin/user/reset-password",{username:l?.username,password:await W(s.password)}),t.success("Password reset"),f(!1)}catch{t.error("Reset failed")}},B=async s=>{try{await i.post("/admin/user/verify",{username:s.username}),t.success("User verified"),C()}catch{t.error("Verification failed")}},L=[{title:"Username",dataIndex:"username",key:"username",render:(s,u)=>e.jsxs(w,{children:[u.username,!u.isVerified&&e.jsx("span",{title:"Unverified",children:e.jsx(ne,{size:16,color:"orange"})})]})},{title:"Email",dataIndex:"email",key:"email"},{title:"Role",dataIndex:"role",key:"role",render:s=>e.jsx(ee,{color:s==="root"?"red":s==="admin"?"blue":"green",children:s.toUpperCase()})},{title:"Actions",key:"actions",render:(s,u)=>e.jsxs(w,{children:[e.jsx(p,{icon:e.jsx(P,{size:14}),size:"small",onClick:()=>M(u),title:"Edit Profile"}),e.jsx(p,{icon:e.jsx(se,{size:14}),size:"small",onClick:()=>O(u),title:"Reset Password"}),e.jsx(p,{danger:!0,icon:e.jsx(E,{size:14}),size:"small",onClick:()=>_(u.username),title:"Delete User"}),!u.isVerified&&e.jsx(p,{icon:e.jsx(te,{size:14}),size:"small",onClick:()=>B(u),title:"Verify User",type:"primary",ghost:!0})]})}];return e.jsxs(e.Fragment,{children:[e.jsxs(w.Compact,{className:"w-full mb-5",children:[e.jsx(U,{placeholder:"Search users...",prefix:e.jsx(D,{}),value:m,onChange:s=>o(s.target.value),onPressEnter:C,className:"max-w-md"}),e.jsx(p,{type:"primary",onClick:C,children:"Search"})]}),e.jsx(R,{columns:L,dataSource:x,rowKey:"username",loading:S,pagination:{pageSize:10}}),e.jsx(F,{title:"Edit User",open:y,onOk:q,onCancel:()=>d(!1),children:e.jsxs(j,{form:r,layout:"vertical",children:[e.jsx(j.Item,{name:"email",label:"Email",rules:[{required:!0}],children:e.jsx(U,{})}),e.jsx(j.Item,{name:"nickname",label:"Nickname",children:e.jsx(U,{})}),e.jsx(j.Item,{name:"avatarUrl",label:"Avatar URL",children:e.jsx(U,{})}),c==="root"&&e.jsx(j.Item,{name:"role",label:e.jsxs(e.Fragment,{children:[e.jsx(T,{size:16})," Role"]}),children:e.jsxs(A,{children:[e.jsx(A.Option,{value:"user",children:"User"}),e.jsx(A.Option,{value:"admin",children:"Admin"}),e.jsx(A.Option,{value:"root",children:"Root"})]})})]})}),e.jsx(F,{title:"Reset Password",open:v,onOk:$,onCancel:()=>f(!1),children:e.jsx(j,{form:k,layout:"vertical",children:e.jsx(j.Item,{name:"password",label:"New Password",rules:[{required:!0}],children:e.jsx(U.Password,{})})})})]})}function ue({systemRole:c}){const{message:t,modal:b}=z.useApp(),[S,h]=n.useState(!1),[x,g]=n.useState([]),[m,o]=n.useState(""),y=N();n.useEffect(()=>{d()},[]);const d=async()=>{h(!0);try{const a=m?`/admin/apps?q=${m}`:"/admin/apps",{data:r}=await i.get(a);g(r.data||[])}catch{t.error("Failed to fetch apps")}finally{h(!1)}},v=async(a,r)=>{try{await i.post("/admin/app/suspend",{appId:a,suspendUntil:r?r.toISOString():null}),t.success("Suspension updated"),d()}catch{t.error("Failed to update suspension")}},f=async a=>{b.confirm({title:"Delete App?",content:"This will delete the app and all associated data permanently. Cannot be undone.",okType:"danger",onOk:async()=>{try{await i.post(`/admin/app/delete?id=${a}`),t.success("App deleted"),d()}catch{t.error("Delete failed")}}})},l=[{title:"Name",dataIndex:"name",key:"name",render:(a,r)=>e.jsxs(w,{children:[e.jsx(K,{url:{url:r.logoUrl,text:a},size:"small"}),a]})},{title:"ID",dataIndex:"id",key:"id",ellipsis:!0},{title:"Description",dataIndex:"description",key:"description",ellipsis:!0},{title:"Suspension",dataIndex:"suspendUntil",key:"suspendUntil",render:(a,r)=>e.jsx(J,{size:"small",showTime:!0,value:a?G(a):null,onChange:k=>v(r.id,k),allowClear:!0})},{title:"Actions",key:"actions",render:(a,r)=>e.jsxs(w,{children:[e.jsx(p,{icon:e.jsx(P,{size:14}),size:"small",onClick:()=>y(`/manage/${r.id}`),title:"Edit App"}),e.jsx(p,{danger:!0,icon:e.jsx(E,{size:14}),size:"small",onClick:()=>f(r.id),title:"Delete App"})]})}];return e.jsxs(e.Fragment,{children:[e.jsxs(w.Compact,{className:"w-full mb-5",children:[e.jsx(U,{placeholder:"Search apps...",prefix:e.jsx(D,{}),value:m,onChange:a=>o(a.target.value),onPressEnter:d,className:"max-w-md"}),e.jsx(p,{type:"primary",onClick:d,children:"Search"})]}),e.jsx(R,{columns:l,dataSource:x,rowKey:"id",loading:S,pagination:{pageSize:10}})]})}function pe(){const{message:c}=z.useApp(),[t,b]=n.useState([]),[S,h]=n.useState(!1);n.useEffect(()=>{x()},[]);const x=async()=>{h(!0);try{const{data:o}=await i.get("/admin/blobs");b(o.data||[])}catch{c.error("Failed to load blobs")}finally{h(!1)}},g=async o=>{try{await i.post("/admin/blob/delete",{id:o}),c.success("Deleted"),x()}catch{c.error("Delete failed")}},m=async o=>{const{file:y,onSuccess:d,onError:v}=o,f=new FormData;f.append("file",y);try{await i.post("/admin/blob/upload",f,{headers:{"Content-Type":"multipart/form-data"}}),c.success("Uploaded"),d("ok"),x()}catch(l){v(l),c.error("Upload failed")}};return e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsx(Q,{customRequest:m,showUploadList:!1,children:e.jsx(p,{icon:e.jsx(H,{}),children:"Upload Blob"})})}),e.jsx(R,{dataSource:t,rowKey:"ID",loading:S,columns:[{title:"ID",dataIndex:"ID",render:o=>e.jsx("a",{href:`${i.defaults.baseURL||""}/blob/${o}`,target:"_blank",rel:"noreferrer",children:o})},{title:"Size",dataIndex:"Size",render:o=>(o/1024).toFixed(1)+" KB"},{title:"Type",dataIndex:"ContentType"},{title:"Action",render:(o,y)=>e.jsx(p,{danger:!0,size:"small",onClick:()=>g(y.ID),icon:e.jsx(E,{size:14})})}]})]})}function Se(){const{message:c}=z.useApp(),[t,b]=n.useState(""),[S,h]=n.useState(!0),x=N(),[g,m]=n.useState(""),[o,y]=n.useState(null);n.useEffect(()=>{d()},[]);const d=async()=>{try{const{data:l}=await i.get("/myapps"),r=(l.data||[]).find(k=>k.name==="system");if(!r||r.role!=="admin"&&r.role!=="root"){c.error("Unauthorized access"),x("/dashboard");return}b(r.role)}catch(l){const a=l;c.error(a.response?.data?.error||"Failed to authenticate")}finally{h(!1)}};if(S)return e.jsx(V,{});const v=async()=>{try{const{data:l}=await i.post("/root/sql",{query:g});y(l.data),c.success("Query executed")}catch(l){const a=l;c.error(a.response?.data?.error||"Query failed"),y(null)}},f=[{key:"1",label:"Users",children:e.jsx(de,{systemRole:t})},{key:"2",label:"Applications",children:e.jsx(ue,{systemRole:t})},{key:"3",label:"Blobs",children:e.jsx(pe,{})}];return e.jsx(X,{title:"System Management",className:"shadow-xl w-full max-w-4xl",extra:e.jsx(p,{icon:e.jsx(Z,{}),onClick:()=>x(-1),children:"Back"}),children:e.jsxs(w,{orientation:"vertical",className:"w-full",children:[e.jsx(Y,{defaultActiveKey:"1",items:f}),t==="root"&&e.jsx("div",{className:"bg-gray-50 dark:bg-gray-900 p-6 rounded-xl border border-gray-200 dark:border-gray-700 mt-8",children:e.jsxs(w,{orientation:"vertical",className:"w-full",children:[e.jsx(ce,{rows:4,value:g,onChange:l=>m(l.target.value),placeholder:"SELECT * FROM users;",className:"font-mono border-none"}),e.jsxs(p,{type:"primary",onClick:v,children:[e.jsx(T,{size:18}),"Execute SQL"]}),o&&e.jsx("div",{className:"overflow-x-auto p-2 rounded-lg mt-2 border border-gray-200",children:e.jsx("pre",{className:"text-xs font-mono",children:JSON.stringify(o,null,2)})})]})})]})})}export{Se as default};
